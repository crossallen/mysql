# [MVCC](https://mp.weixin.qq.com/s/iCuAqapMjzDyPqn6FnwHXg)
## 什么是MVCC
> 多版本并发控制(MVCC)，是一种用来==解决读-写冲突的无锁并发控制==，也就是为事务分配单向增长的时间戳，为每个修改保存一个版本，版本与事务戳关联，读操作只读事务开始前的数据库的快照。这样在读操作的时候不会阻塞写操作，写操作不会阻塞读操作的同时，也避免了脏读和不可重复读。
## 什么是当前读快照读
>当前读：读取记录的最新版本，所以读取时不能被其他事务修改当前记录，需要对记录加锁。  
>快照读：快照读的出现，主要解决了在不加锁的情况下也可以进行读取，降低了锁开销；它的实现是基础多版本并发控制，即MVCC；由于它是基于多版本并发控制，所以使用快照读读取的记录并不一定是最新记录。
## MVCC实现原理
MVCC就是多版本并发控制，用来解决读写冲突。它主要由隐藏字段，undolog日志，read-view来配合完成的。  
### 隐藏字段
> roll_pointer：回滚指针，指向这条记录的上一个版本  
> trx_id：事务ID，记录创建/修改这条记录的事务ID，用于版本比较，从而找到快照
### undolog日志
> undolog日志存储某条记录的所有操作，以链表方式将各个版本进行串联起来
### read-view一致性视图
> 当事务第一次执行查询sql时会生成一致性视图read-view，它由执行查询时所有未提交事务ID数组(数组里最小的ID为min_id)和已创建的最大事务id(max_id)组成，查询的数据结果需要跟read-view做比较从而得到快照结果
### 版本链比对规则：
>1:如果落在绿色部分(trx_id<min_id)，表示这个版本是已提交的事物生成的，这个数据是可见的  
>2:如果落在红色部分(trx_id>max)，表示这个版本是由将来启动的事务生成的，是肯定不可见的  
>3:如果落在黄色部分(min_id<=trx_id<=max_id)，那就包括两种情况  
>&nbsp;&nbsp;&nbsp;&nbsp;a:若row的trx_id在数组中，表示这个版本是由还没提交的事务生成的，不可见，当前自己的事务是可见的  
>&nbsp;&nbsp;&nbsp;&nbsp;b:若row的trx_id不在数组中，表示这个版本是已经提交的事务生成的，是可见的
# [事务](https://zhuanlan.zhihu.com/p/148035779)
> 数据库的事务是指一组sql语句组成的数据库逻辑处理单元，在这组的sql操作中，要么全部执行成功，要么全部执行失败。比如银行转账。
## 事务的特性ACID
> 在Mysql中事务的四大特性主要包含：原子性（Atomicity）、一致性（Consistent）、隔离性（Isalotion）、持久性(Durable)，简称为ACID。  
> 原子性：事务的原子操作，要么全部成功，要么全部失败，实现事务的原子性依赖日志的redo/undo机制  
> 一致性：事务前后的状态要一致，可以理解为数据一致性。   
> 隔离性：事务之间相互隔离，不受影响，这个与事务设置的隔离级别有密切的关系。  
> 持久性：一个事务提交之后，事务的状态会被持久化到数据库中，也就是事务所有增删改都会持久化到数据库中
## 事务的隔离级别
### 读未提交
> 在另外事务中为提交的数据也可以读到，会产生脏读问题。
### 读提交
> 读提交的数据则解决了脏读的问题，但是会出现不可重复读的问题（即在一个事务任意时刻读到的数据可能不一样，比如在事务的执行过程中有另外的事务修改了数据。这个是由read-view的获得方式决定的，读提交在每次执行语句的时候都会重建read-view视图，重复读就是在事务开始只获得一次read-view视图）
### 重复读
> 解决了不可重复读和脏读，依赖的就是每次操作都重新获得read-view一致性视图，但是会出现幻读问题（幻读一般针对insert操作，比如A事务查询id为100的数据发现不存在，此时B事务新增一条id为100的数据并且提交了，这时候A事务新增id为100的数据就会报主键冲突）
### 串行化
# 二级缓存
# 日志
## redo
> 记录某数据块被修改后的值
## undo
> 记录数据更新前的值，保证数据更新失败能够回滚。
## 例子
> 在某个时刻数据库崩溃，在崩溃前有事务A和B。A事务已经提交，B事务还未提交。当数据库重启进行crash-recovery时，就会通过redo log将已经提交的事务的更改写到数据文件，而还没有提交的就通过undo log来进行回滚
## binlog
# 索引的数据结构
# mysql优化
# mysql数据的写入过程
# 脏读 幻读 不可重复读
# 锁
# 对同一行数据同时可以有多个事务吗
